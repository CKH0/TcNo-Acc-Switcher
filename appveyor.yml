version: 1.0.0.{build}
matrix:
  fast_finish: true

# https://www.appveyor.com/docs/build-environment/#build-worker-images
image: Visual Studio 2022

environment:
  # Disable the .NET logo in the console output.
  DOTNET_NOLOGO: true
  # Disable the .NET first time experience to skip caching NuGet packages and speed up the build.
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  # Use latest version of current used .NET version.  6.0 could use the latest of 6.0.  See .\buildscripts\Update-DotnetVersion.ps1
  GE_USE_LATEST_DOTNET: true
  # Only build Release
  CONFIGURATION: release
  VCPKG_BUILD_TYPE: release

pull_requests:
  do_not_increment_build_number: true

init:
  - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
  - ps: iex (irm https://raw.githubusercontent.com/TCNOco/TcNo-Acc-Switcher/appveyor/other/NSIS/nsis7zplugin.ps1)

# Build settings, not to be confused with "before_build" and "after_build".
# "project" is relative to the original build directory and not influenced by directory changes in "before_build".
build:
  # enable MSBuild parallel builds
  parallel: true
  # MSBuild verbosity level
  verbosity: minimal

install:
  # Install the required packages
  - vcpkg install curl:x64-windows-static curl[ssl]:x64-windows-static vcpkg-cmake:x64-windows vcpkg-cmake-config:x64-windows zlib:x64-windows-static --triplet=x64-windows-release
  - vcpkg integrate install
  - choco upgrade aria2 -y

# Build configuration
build_script:
  - nuget restore TcNo-Acc-Switcher.sln
  - msbuild Installer/Installer.vcxproj /p:Configuration=%CONFIGURATION% /p:Platform=x64 /p:OutDir=%APPVEYOR_BUILD_FOLDER%\TcNo-Acc-Switcher-Client\bin\Installer\
  - msbuild _Updater_Wrapper/_Updater_Wrapper.vcxproj /p:Configuration=%CONFIGURATION% /p:Platform=x64 /p:OutDir=%APPVEYOR_BUILD_FOLDER%\TcNo-Acc-Switcher-Client\bin\Wrapper\
  - msbuild runas/runas.csproj /p:Configuration=%CONFIGURATION% /p:Platform=x64 /p:OutputPath=%APPVEYOR_BUILD_FOLDER%\TcNo-Acc-Switcher-Client\bin\runas\x64\Release\net8.0\
  - msbuild TcNo-Acc-Switcher-Globals/TcNo-Acc-Switcher-Globals.csproj /p:Configuration=%CONFIGURATION% /p:Platform=x64
  - msbuild TcNo-Acc-Switcher-Tray/TcNo-Acc-Switcher-Tray.csproj /p:Configuration=%CONFIGURATION% /p:Platform=x64
  - msbuild TcNo-Acc-Switcher-Updater/TcNo-Acc-Switcher-Updater.csproj /p:Configuration=%CONFIGURATION% /p:Platform=x64
  - msbuild TcNo-Acc-Switcher-Server/TcNo-Acc-Switcher-Server.csproj /p:Configuration=%CONFIGURATION% /p:Platform=x64
  - msbuild TcNo-Acc-Switcher-Client/TcNo-Acc-Switcher-Client.csproj /p:Configuration=%CONFIGURATION% /p:Platform=x64

on_finish:
  - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
#  - ps: TcNo-Acc-Switcher-Client\PostBuild.bat

artifacts:
  - path: TcNo-Acc-Switcher-Client\bin\x64\Release\CEF.7z
    name: CEF.7z
  - path: TcNo-Acc-Switcher-Client\bin\x64\Release\TcNo Account Switcher - Installer.exe
    name: TcNo Account Switcher - Installer_$(APPVEYOR_REPO_TAG_NAME).exe
  - path: TcNo-Acc-Switcher-Client\bin\x64\Release\TcNo-Acc-Switcher.7z
    name: TcNo-Acc-Switcher_$(APPVEYOR_REPO_TAG_NAME).7z
  - path: TcNo-Acc-Switcher-Client\bin\x64\Release\TcNo-Acc-Switcher.zip
    name: TcNo-Acc-Switcher_$(APPVEYOR_REPO_TAG_NAME).zip
  - path: TcNo-Acc-Switcher-Client\bin\x64\Release\TcNo-Acc-Switcher_and_CEF.7z
    name: TcNo-Acc-Switcher_and_CEF_$(APPVEYOR_REPO_TAG_NAME).7z
  - path: TcNo-Acc-Switcher-Client\bin\x64\Release\UpdateDiff.7z
    name: $(APPVEYOR_REPO_TAG_NAME).7z

deploy:
  release: Build-v$(APPVEYOR_REPO_TAG_NAME)
  description: 'Release description'
  provider: GitHub
  auth_token:
    secure: 4mZ2nTS7qLwiVng07ki64e5M027auJxwDh92GRw9F9Eh4XwMCoBHm2XOqgj/Z5S8
  artifact: CEF.7z,TcNo Account Switcher - Installer_$(APPVEYOR_REPO_TAG_NAME).exe,TcNo-Acc-Switcher_$(APPVEYOR_REPO_TAG_NAME).7z,TcNo-Acc-Switcher_$(APPVEYOR_REPO_TAG_NAME).zip,TcNo-Acc-Switcher_$(APPVEYOR_REPO_TAG_NAME).7z
  draft: true
  prerelease: false
  on:
    branch: appveyor
    APPVEYOR_REPO_TAG: true